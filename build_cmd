#!/usr/bin/env bash

USE_LOCAL_SW=""
export LOCAL_TAG="latest-o2physics-o2"

CMAKE_DEBUG_OPTS="1"
[[ -n ${CMAKE_DO_TRACE} ]] && CMAKE_DEBUG_OPTS=" --debug-output --debug-find --trace --trace-expand --trace-format=human --trace-redirect=cmake_trace.log "

mkdir -p BUILD INSTALL
rm -rf BUILD/* INSTALL/*

if [[ -n "${USE_LOCAL_SW}" ]]; then
    export O2PHYS_TAG="${LOCAL_TAG}"
    export WORK_DIR="${ALIBUILD_WORK_DIR}" ALIBUILD_ARCH_PREFIX="$(aliBuild architecture)" DISABLE_GPU=1
else
    export O2PHYS_TAG="nightly-20221027-1"
    export WORK_DIR="/cvmfs/alice.cern.ch" ALIBUILD_ARCH_PREFIX="el7-x86_64/Packages" DISABLE_GPU=1
fi

if [[ -n "${USE_LOCAL_SW}" ]]; then
    source ${WORK_DIR}/${ALIBUILD_ARCH_PREFIX}/XRootD/${O2PHYS_TAG}/etc/profile.d/init.sh
fi

# source ${WORK_DIR}/${ALIBUILD_ARCH_PREFIX}/JAliEn-ROOT/${BUILD_TAG}/etc/profile.d/init.sh
# source ${WORK_DIR}/${ALIBUILD_ARCH_PREFIX}/libjalienO2/${BUILD_TAG}/etc/profile.d/init.sh
# source ${WORK_DIR}/${ALIBUILD_ARCH_PREFIX}/O2/${BUILD_TAG}/etc/profile.d/init.sh
source "${WORK_DIR}"/"${ALIBUILD_ARCH_PREFIX}"/O2Physics/${O2PHYS_TAG}/etc/profile.d/init.sh
env > compilation_env.txt

pushd BUILD
cmake3 -DCMAKE_INSTALL_PREFIX=../INSTALL -DBUILD_TEST_ROOT_MACROS=OFF ${CMAKE_DEBUG_OPTS} \
    -DLIBJALIENO2_INCLUDE_DIR=${LIBJALIENO2_ROOT}/include -DLIBJALIENO2_LIBPATH=${LIBJALIENO2_ROOT}/lib/libjalienO2.so \
    -DJALIEN_ROOT_INCLUDE_DIR=${JALIEN_ROOT_ROOT}/include -DJAliEnRoot_LIB=${JALIEN_ROOT_ROOT}/lib/libJAliEnROOT.so \
    .. 

RET=$?

[[ "${RET}" == 0 ]] && make -j4 || { popd; echo "cmake failure"; exit ${RET}; }
[[ "${RET}" == 0 ]] && make install || { popd;  echo "make failure"; exit ${RET}; }

popd

